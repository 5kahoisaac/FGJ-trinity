name: Bug â†’ Jira Ticket (via GitHub Models)

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write
  contents: read
  models: read       # Required for GitHub Models inference

jobs:
  extract-and-create-jira:
    environment: development
    if: contains(github.event.issue.labels.*.name, 'bug')
    runs-on: ubuntu-latest
    steps:
      - name: Extract structured bug data using GitHub Models (gpt-4o)
        id: extract
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            https://models.github.ai/inference/chat/completions \
            -d '{
              "model": "openai/gpt-4o",
              "messages": [
                {
                  "role": "system",
                  "content": "You are a precise bug report parser. Analyze the GitHub issue and output **ONLY** valid JSON (no extra text, no markdown). Use these exact keys:\n{\"summary\": \"short one-line bug title\", \"description\": \"full bug details including reproduction steps and context\", \"priority\": \"High|Medium|Low\", \"figma_url\": \"direct Figma prototype/node link or empty string\", \"screenshot_url\": \"direct image URL from issue or empty\"}\nIf uncertain, use reasonable defaults. Do NOT include project_key."
                },
                {
                  "role": "user",
                  "content": "Title: \"${ISSUE_TITLE}\"\n\nBody:\n${ISSUE_BODY}"
                }
              ],
              "max_tokens": 600,
              "temperature": 0.0
            }')

          echo "raw_response=$RESPONSE" >> $GITHUB_OUTPUT

          # Parse safely
          if echo "$RESPONSE" | jq -e '.choices[0].message.content | fromjson' > /dev/null 2>&1; then
            CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content | fromjson')
            SUMMARY=$(echo "$CONTENT" | jq -r '.summary // "'"$ISSUE_TITLE"' - Auto Bug"')
            DESCRIPTION=$(echo "$CONTENT" | jq -r '.description // "'"$ISSUE_BODY"'"')
            PRIORITY=$(echo "$CONTENT" | jq -r '.priority // "Medium"')
            FIGMA_URL=$(echo "$CONTENT" | jq -r '.figma_url // ""')
            SCREENSHOT_URL=$(echo "$CONTENT" | jq -r '.screenshot_url // ""')
          else
            # Fallback on AI failure
            SUMMARY="$ISSUE_TITLE - Bug Report"
            DESCRIPTION="$ISSUE_BODY"
            PRIORITY="Medium"
            FIGMA_URL=""
            SCREENSHOT_URL=""
            echo "Warning: AI parsing failed, using fallback values"
          fi

          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "priority=$PRIORITY" >> $GITHUB_OUTPUT
          echo "figma_url=$FIGMA_URL" >> $GITHUB_OUTPUT
          echo "screenshot_url=$SCREENSHOT_URL" >> $GITHUB_OUTPUT

      - name: Login to Jira (for gajira)
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Create Jira Bug Ticket
        id: create-jira
        uses: atlassian/gajira-create@v3
        with:
          project: KAN
          issuetype: Bug
          summary: ${{ steps.extract.outputs.summary }}
          description: |
            ${{ steps.extract.outputs.description }}

            **Figma Link:** ${{ steps.extract.outputs.figma_url || 'None' }}

            **Screenshot:** ${{ steps.extract.outputs.screenshot_url || 'None' }}

            **Priority (extracted):** ${{ steps.extract.outputs.priority || 'Medium' }}

            Auto-created from GitHub issue #${{ github.event.issue.number }}
            via GitHub Actions + GitHub Models (gpt-4o).

      - name: Set Jira URL for next step
        if: steps.create-jira.outputs.issue != ''
        run: |
          echo "JIRA_KEY=${{ steps.create-jira.outputs.issue }}" >> $GITHUB_ENV
          echo "JIRA_URL=${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.create-jira.outputs.issue }}" >> $GITHUB_ENV

      - name: Comment Jira Link Back to GitHub Issue
        if: env.JIRA_URL != ''
        uses: actions/github-script@v7
        with:
          script: |
            const body = `**Jira Ticket Created Automatically**: ${{ env.JIRA_URL }} (Key: ${{ env.JIRA_KEY }})

            **Extracted by GitHub Models (gpt-4o):**
            - Summary: ${{ steps.extract.outputs.summary }}
            - Priority: ${{ steps.extract.outputs.priority || 'Medium' }}
            - Figma: ${{ steps.extract.outputs.figma_url || 'None' }}
            - Screenshot: ${{ steps.extract.outputs.screenshot_url || 'None' }}

            (Triggered from GitHub issue #${{ github.event.issue.number }})`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

name: Bug → Jira Ticket (via GitHub Models)

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write
  contents: read
  models: read       # Required for GitHub Models inference

jobs:
  extract-and-create-jira:
    environment: development   # ← This was missing; runs in the "development" GitHub environment
    if: contains(github.event.issue.labels.*.name, 'bug')
    runs-on: ubuntu-latest
    steps:
      - name: Extract structured bug data using GitHub Models (gpt-4o)
        id: extract
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Call GitHub Models inference endpoint
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            https://models.github.ai/inference/chat/completions \
            -d '{
              "model": "openai/gpt-4o",
              "messages": [
                {
                  "role": "system",
                  "content": "You are a precise bug report parser. Analyze the GitHub issue and output **ONLY** valid JSON (no extra text, no markdown). Use these exact keys:\n{\"summary\": \"short one-line bug title\", \"description\": \"full bug details including reproduction steps and context\", \"priority\": \"High|Medium|Low\", \"figma_url\": \"direct Figma prototype/node link or empty string\", \"screenshot_url\": \"direct image URL from issue or empty\", \"project_key\": \"JIRA project key like PROJ\"}\nIf uncertain, use reasonable defaults."
                },
                {
                  "role": "user",
                  "content": "Title: \"${ISSUE_TITLE}\"\n\nBody:\n${ISSUE_BODY}"
                }
              ],
              "max_tokens": 600,
              "temperature": 0.0
            }')

          echo "raw_response=$RESPONSE" >> $GITHUB_OUTPUT

          # Parse safely
          if echo "$RESPONSE" | jq -e '.choices[0].message.content | fromjson' > /dev/null 2>&1; then
            CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content | fromjson')
            SUMMARY=$(echo "$CONTENT" | jq -r '.summary // "'"$ISSUE_TITLE"' - Auto Bug"')
            DESCRIPTION=$(echo "$CONTENT" | jq -r '.description // "'"$ISSUE_BODY"'"')
            PRIORITY=$(echo "$CONTENT" | jq -r '.priority // "Medium"')
            FIGMA_URL=$(echo "$CONTENT" | jq -r '.figma_url // ""')
            SCREENSHOT_URL=$(echo "$CONTENT" | jq -r '.screenshot_url // ""')
            PROJECT_KEY=$(echo "$CONTENT" | jq -r '.project_key // "YOURPROJECT"')
          else
            # Fallback on AI failure
            SUMMARY="$ISSUE_TITLE - Bug Report"
            DESCRIPTION="$ISSUE_BODY"
            PRIORITY="Medium"
            FIGMA_URL=""
            SCREENSHOT_URL=""
            PROJECT_KEY="YOURPROJECT"
            echo "Warning: AI parsing failed, using fallback values"
          fi

          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "priority=$PRIORITY" >> $GITHUB_OUTPUT
          echo "figma_url=$FIGMA_URL" >> $GITHUB_OUTPUT
          echo "screenshot_url=$SCREENSHOT_URL" >> $GITHUB_OUTPUT
          echo "project_key=$PROJECT_KEY" >> $GITHUB_OUTPUT

      - name: Create Jira Bug Ticket
        if: steps.extract.outputs.summary != ''
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          PAYLOAD=$(jq -n \
            --arg summary "${{ steps.extract.outputs.summary }}" \
            --arg desc "${{ steps.extract.outputs.description }}" \
            --arg figma "${{ steps.extract.outputs.figma_url }}" \
            --arg screenshot "${{ steps.extract.outputs.screenshot_url }}" \
            --arg project "${{ steps.extract.outputs.project_key }}" \
            --arg priority "${{ steps.extract.outputs.priority }}" \
            '{
              "fields": {
                "project": {"key": $project},
                "summary": $summary,
                "description": ($desc + "\n\n**Figma Link:** " + $figma + "\n**Screenshot:** " + $screenshot + "\n\nAuto-created from GitHub issue #" + (env.GITHUB_EVENT_ISSUE_NUMBER // "unknown") + " via AI"),
                "issuetype": {"name": "Bug"},
                "priority": {"name": $priority}
              }
            }')

          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Basic $(echo -n $JIRA_EMAIL:$JIRA_API_TOKEN | base64)" \
            -H "Content-Type: application/json" \
            "$JIRA_BASE_URL/rest/api/3/issue" \
            -d "$PAYLOAD")

          echo "$RESPONSE" > jira_response.json

          JIRA_KEY=$(jq -r '.key // empty' jira_response.json)
          if [ -n "$JIRA_KEY" ] && [ "$JIRA_KEY" != "null" ]; then
            JIRA_URL="$JIRA_BASE_URL/browse/$JIRA_KEY"
            echo "JIRA_URL=$JIRA_URL" >> $GITHUB_ENV
            echo "Created Jira ticket: $JIRA_KEY → $JIRA_URL"
          else
            echo "Jira creation failed:"
            cat jira_response.json
            exit 1
          fi

      - name: Comment Jira Link Back to GitHub Issue
        if: env.JIRA_URL != ''
        uses: actions/github-script@v7
        with:
          script: |
            const body = `**Jira Ticket Created Automatically**: ${{ env.JIRA_URL }}

            **Extracted by GitHub Models (gpt-4o):**
            - Summary: ${{ steps.extract.outputs.summary }}
            - Priority: ${{ steps.extract.outputs.priority }}
            - Figma: ${{ steps.extract.outputs.figma_url || 'None' }}
            - Screenshot: ${{ steps.extract.outputs.screenshot_url || 'None' }}

            (Triggered from GitHub issue #${{ github.event.issue.number }})`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

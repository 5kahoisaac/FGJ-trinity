name: Bug → Jira Ticket (via GitHub Models)

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read
  models: read

jobs:
  sync-bug-to-jira:
    environment: development
    if: contains(github.event.issue.labels.*.name, 'bug')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Extract issue details
        id: inference
        uses: actions/ai-inference@v1
        with:
          prompt-file: './prompts/issue-extract.prompt.yml'
          input: |
            body: |
              ${{ github.event.issue.body }}

      - name: Login
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ vars.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ vars.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Prepare Jira fields
        id: jira_fields
        run: |
          response="${{ steps.inference.outputs.response }}"

          priority=$(echo "$response" | jq -r '.priority')
          content=$(echo "$response" | jq -r '.content')

          figma_section=$(echo "$response" | jq -r 'if (.figma_urls | length) > 0 then "h2. Figma Designs\n" + (.figma_urls | map("* " + .) | join("\n")) + "\n\n" else "h2. Figma Designs\nNone provided.\n\n" end')

          attach_section=$(echo "$response" | jq -r 'if (.attachment_urls | length) > 0 then "h2. Attachments\nAttachments have been uploaded to this Jira ticket via automation.\n\n" else "" end')

          attachment_urls=$(echo "$response" | jq -r '.attachment_urls[]' 2>/dev/null | tr '\n' ' ' | sed 's/[[:space:]]*$//' || echo "")

          echo "attachment_urls=$attachment_urls" >> $GITHUB_OUTPUT

          echo "description<<DELIMITER" >> $GITHUB_OUTPUT
          echo "h2. Priority" >> $GITHUB_OUTPUT
          echo "*$priority*" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "h2. GitHub Issue" >> $GITHUB_OUTPUT
          echo "[#${{ github.event.issue.number }} - ${{ github.event.issue.title }}|${{ github.event.issue.html_url }}]" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "h2. Summary" >> $GITHUB_OUTPUT
          echo "$content" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "$figma_section" >> $GITHUB_OUTPUT
          echo "$attach_section" >> $GITHUB_OUTPUT
          echo "DELIMITER" >> $GITHUB_OUTPUT

      - name: Create Jira Issue
        id: create
        uses: atlassian/gajira-todo@v3
        with:
          project: ${{ vars.JIRA_PROJECT_KEY }}
          issuetype: Bug
          summary: ${{ github.event.issue.title }}
          description: Created automatically via GitHub Actions
        env:
          GITHUB_TOKEN: ${{ steps.jira_fields.outputs.description }}

      - name: Download and Upload Attachments
        if: steps.jira_fields.outputs.attachment_urls != ''
        env:
          JIRA_BASE_URL: ${{ vars.JIRA_BASE_URL }}
          JIRA_EMAIL: ${{ vars.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_KEY: ${{ steps.create.outputs.issue }}
          ATTACHMENT_URLS: ${{ steps.jira_fields.outputs.attachment_urls }}
        run: |
          mkdir -p ~/attachments
          cd ~/attachments

          for url in $ATTACHMENT_URLS; do
            filename=$(basename "$url" | cut -d'?' -f1)
            echo "Downloading: $url → $filename"
            curl -fsSL -o "$filename" "$url" || {
              echo "Failed to download $url"
              continue
            }

            if [ ! -s "$filename" ]; then
              echo "$filename is empty – skipping upload"
              continue
            fi

            echo "Uploading $filename to Jira $JIRA_KEY"
            http_code=$(curl -s -w "%{http_code}" -o /tmp/upload_response.json \
              -H "X-Atlassian-Token: no-check" \
              -u "$JIRA_EMAIL:$JIRA_TOKEN" \
              -X POST \
              -F "file=@$filename" \
              "$JIRA_BASE_URL/rest/api/3/issue/$JIRA_KEY/attachments")

            if [[ $http_code =~ ^2 ]]; then
              echo "Successfully uploaded $filename"
            else
              echo "Upload failed with HTTP $http_code"
              cat /tmp/upload_response.json || true
            fi
          done

      - name: Comment Jira link on GitHub issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = `**Jira Ticket**: ${{ vars.JIRA_BASE_URL }}/browse/${{ steps.create.outputs.issue }}`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
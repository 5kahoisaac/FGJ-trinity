name: Issue to Jira Ticket
on:
  issues:
    types: [opened]
permissions:
  issues: write
  models: read

jobs:
  extract-and-create-jira:
    environment: development
    if: contains(github.event.issue.labels.*.name, 'bug')
    runs-on: ubuntu-latest
    steps:
    - name: Extract bug data with AI
      id: extract
      env:
        ISSUE_BODY: ${{ github.event.issue.body }}
        ISSUE_NUMBER: ${{ github.event.issue.number }}
        ISSUE_TITLE: ${{ github.event.issue.title }}
      run: |
        RESPONSE=$(curl -s -X POST \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHubActions" \
          -d '{
            "model": "gpt-4o",
            "messages": [{
              "role": "user",
              "content": "Extract bug report fields from this GitHub issue. Look for screenshot URLs, Figma links, expected/actual text. Output ONLY valid JSON:\n{\n  \"summary\": \"One-line bug summary\",\n  \"description\": \"Full description with steps\",\n  \"priority\": \"High|Medium|Low\",\n  \"figma_url\": \"Figma prototype/node link or empty\",\n  \"screenshot_url\": \"GitHub image URL or empty\",\n  \"project_key\": \"YOUR-PROJECT-KEY\"\n}\n\nIssue Title: '"${ISSUE_TITLE}"'\nIssue Body:\n${ISSUE_BODY}"
            }],
            "max_tokens": 500,
            "temperature": 0.1
          }' \
          https://models.github.com/v1/chat/completions)
        
        echo "response=$RESPONSE" >> $GITHUB_OUTPUT
        
        if echo "$RESPONSE" | jq -e .choices >/dev/null 2>&1; then
          SUMMARY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content | fromjson | .summary // empty')
          FIGMA_URL=$(echo "$RESPONSE" | jq -r '.choices[0].message.content | fromjson | .figma_url // empty')
          PRIORITY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content | fromjson | .priority // "Medium"')
          DESCRIPTION=$(echo "$RESPONSE" | jq -r '.choices[0].message.content | fromjson | .description // "Bug reported via Figma widget"')
          PROJECT_KEY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content | fromjson | .project_key // "YOUR-PROJECT-KEY"')
          SCREENSHOT_URL=$(echo "$RESPONSE" | jq -r '.choices[0].message.content | fromjson | .screenshot_url // empty')
        else
          SUMMARY="Failed to parse AI response"
          PRIORITY="Medium"
          DESCRIPTION="${ISSUE_BODY}"
          PROJECT_KEY="YOUR-PROJECT-KEY"
          FIGMA_URL=""
          SCREENSHOT_URL=""
        fi
        
        echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
        echo "figma_url=$FIGMA_URL" >> $GITHUB_OUTPUT
        echo "priority=$PRIORITY" >> $GITHUB_OUTPUT
        echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
        echo "project

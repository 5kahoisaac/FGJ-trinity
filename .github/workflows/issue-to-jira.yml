name: Issue to Jira Ticket
on:
  issues:
    types: [opened]
permissions:
  issues: write
  models: read

jobs:
  extract-and-create-jira:
    environment: development
    if: contains(github.event.issue.labels.*.name, 'bug')
    runs-on: ubuntu-latest
    steps:
    - name: Extract bug data with AI
      id: extract
      env:
        ISSUE_BODY: ${{ github.event.issue.body }}
        ISSUE_NUMBER: ${{ github.event.issue.number }}
        ISSUE_TITLE: ${{ github.event.issue.title }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        RESPONSE=$(curl -s -X POST -H "Authorization: Bearer $GITHUB_TOKEN" -H "Content-Type: application/json" -H "User-Agent: GitHubActions" -d '{"model":"gpt-4o","messages":[{"role":"user","content":"Extract bug report fields from GitHub issue. Output ONLY valid JSON: {\"summary\":\"One-line bug summary\",\"description\":\"Full description\",\"priority\":\"High|Medium|Low\",\"figma_url\":\"Figma link or empty\",\"screenshot_url\":\"image URL or empty\",\"project_key\":\"YOUR-PROJECT-KEY\"}\n\nTitle: ${ISSUE_TITLE}\nBody: ${ISSUE_BODY}"}],"max_tokens":500,"temperature":0.1}' https://models.github.com/v1/chat/completions)
        
        echo "response=$RESPONSE" >> $GITHUB_OUTPUT
        
        if echo "$RESPONSE" | jq -e '.choices' >/dev/null 2>&1; then
          SUMMARY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content | fromjson | .summary // empty')
          FIGMA_URL=$(echo "$RESPONSE" | jq -r '.choices[0].message.content | fromjson | .figma_url // empty')
          PRIORITY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content | fromjson | .priority // "Medium"')
          DESCRIPTION=$(echo "$RESPONSE" | jq -r '.choices[0].message.content | fromjson | .description // "${ISSUE_BODY}"')
          PROJECT_KEY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content | fromjson | .project_key // "YOUR-PROJECT-KEY"')
          SCREENSHOT_URL=$(echo "$RESPONSE" | jq -r '.choices[0].message.content | fromjson | .screenshot_url // empty')
        else
          SUMMARY="${ISSUE_TITLE} - Bug Report"
          PRIORITY="Medium"
          DESCRIPTION="${ISSUE_BODY}"
          PROJECT_KEY="YOUR-PROJECT-KEY"
          FIGMA_URL=""
          SCREENSHOT_URL=""
        fi
        
        echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
        echo "figma_url=$FIGMA_URL" >> $GITHUB_OUTPUT
        echo "priority=$PRIORITY" >> $GITHUB_OUTPUT
        echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
        echo "project_key=$PROJECT_KEY" >> $GITHUB_OUTPUT
        echo "screenshot_url=$SCREENSHOT_URL" >> $GITHUB_OUTPUT
        echo "AI raw response: $RESPONSE"

    - name: Create Jira Ticket
      if: steps.extract.outputs.summary != ''
      env:
        JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
        JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
        JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      run: |
        JIRA_PAYLOAD=$(jq -n \
          --arg summary "${{ steps.extract.outputs.summary }}" \
          --arg desc "${{ steps.extract.outputs.description }}" \
          --arg figma "${{ steps.extract.outputs.figma_url }}" \
          --arg screenshot "${{ steps.extract.outputs.screenshot_url }}" \
          --arg project "${{ steps.extract.outputs.project_key }}" \
          --arg priority "${{ steps.extract.outputs.priority }}" \
          '{
            "fields": {
              "project": { "key": $project },
              "summary": $summary,
              "description": ($desc + "\n\nðŸ–¼ï¸ Figma: " + $figma + "\nðŸ“¸ Screenshot: " + $screenshot + "\n\n#bug #figma #automation"),
              "issuetype": { "name": "Bug" },
              "priority": { "name": $priority }
            }
          }')
        
        JIRA_RESPONSE=$(curl -s -X POST \
          "$JIRA_BASE_URL/rest/api/3/issue" \
          -H "Authorization: Basic $(echo -n $JIRA_EMAIL:$JIRA_API_TOKEN | base64)" \
          -H "Content-Type: application/json" \
          -d "$JIRA_PAYLOAD")
        
        echo "$JIRA_RESPONSE"
        
        JIRA_KEY=$(echo "$JIRA_RESPONSE" | jq -r '.key // empty')
        JIRA_URL="$JIRA_BASE_URL/browse/$JIRA_KEY"
        
        if [ "$JIRA_KEY" != "null" ] && [ -n "$JIRA_KEY" ]; then
          echo "JIRA_URL=$JIRA_URL" >> $GITHUB_ENV
          echo "Jira ticket $JIRA_KEY created successfully: $JIRA_URL"
        else
          echo "Failed to create Jira ticket"
          echo "$JIRA_RESPONSE"
          exit 1
        fi

    - name: Comment Jira URL back to GitHub issue
      if: steps.extract.outputs.summary != '' && env.JIRA_URL != ''
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `âœ… **Jira ticket created**: ${{ env.JIRA_URL }}\n\n*(Auto-generated from Figma GitHub widget + GitHub Models AI)*\n\n**Extracted data:**\nâ€¢ Summary: ${{ steps.extract.outputs.summary }}\nâ€¢ Priority: ${{ steps.extract.outputs.priority }}\nâ€¢ Figma: ${{ steps.extract.outputs.figma_url }}`
          })
